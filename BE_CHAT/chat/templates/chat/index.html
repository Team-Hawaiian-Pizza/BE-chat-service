<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅 서비스</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #007bff;
            color: white;
            padding: 15px 20px;
            text-align: center;
        }
        .user-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .user-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .conversations-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .conversation-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .conversation-item:hover {
            background: #f8f9fa;
        }
        .conversation-item.active {
            background: #e7f3ff;
        }
        .chat-area {
            display: none;
            height: 400px;
            border: 1px solid #eee;
            margin: 20px;
            border-radius: 5px;
            flex-direction: column;
        }
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        .load-more-button {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
            border-radius: 5px;
            display: none;
        }
        .load-more-button:hover {
            background: #e9ecef;
        }
        .typing-indicator {
            padding: 10px;
            font-style: italic;
            color: #666;
            display: none;
        }
        .connection-status {
            padding: 5px 10px;
            background: #28a745;
            color: white;
            font-size: 12px;
            border-radius: 3px;
            margin-left: 10px;
        }
        .connection-status.disconnected {
            background: #dc3545;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
        }
        .message.sent {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .message.received {
            background: #e9ecef;
            color: #333;
        }
        .message-input {
            display: flex;
            padding: 20px;
            border-top: 1px solid #eee;
            gap: 10px;
        }
        .status {
            padding: 10px 20px;
            background: #d4edda;
            color: #155724;
            margin-bottom: 10px;
            border-radius: 5px;
            display: none;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>1대1 채팅 서비스 (테스트)</h1>
            <span id="connectionStatus" class="connection-status disconnected">연결 안됨</span>
        </div>
        
        <div class="user-section">
            <h3>사용자 설정</h3>
            <div class="user-input">
                <input type="text" id="userId" placeholder="사용자 ID (예: user1)" value="user1">
                <button onclick="setUser()">설정</button>
            </div>
            
            <div class="user-input">
                <input type="text" id="otherId" placeholder="대화할 상대 ID (예: user2)">
                <button onclick="createConversation()">대화방 생성</button>
            </div>
            
            <div id="status" class="status"></div>
            
            <h4>내 대화방 목록</h4>
            <div id="conversationsList" class="conversations-list">
                <div style="padding: 20px; text-align: center; color: #666;">
                    대화방이 없습니다
                </div>
            </div>
        </div>
        
        <div id="chatArea" class="chat-area">
            <div id="messagesContainer" class="messages-container">
                <div id="loadMoreButton" class="load-more-button" onclick="loadMoreMessages()">
                    이전 메시지 더보기
                </div>
                <div id="messagesContent"></div>
                <div id="typingIndicator" class="typing-indicator">
                    상대방이 입력 중입니다...
                </div>
            </div>
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." 
                       onkeypress="handleKeyPress(event)" 
                       oninput="handleTyping()">
                <button onclick="sendMessage()">전송</button>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수들
        let currentUser = '';
        let currentConversation = null;
        let ws = null;
        let messages = [];
        let hasMoreMessages = false;
        let oldestMessageId = null;
        let typingTimer = null;
        let isTyping = false;
        let autoRefreshInterval = null;  // 자동 새로고침용

        // 사용자 설정
        function setUser() {
            currentUser = document.getElementById('userId').value.trim();
            if (currentUser) {
                showStatus('사용자 설정 완료: ' + currentUser);
                loadConversations();
            }
        }

        // 대화방 생성
        async function createConversation() {
            if (!currentUser) {
                showStatus('먼저 사용자 ID를 설정해주세요.', 'error');
                return;
            }
            
            const otherId = document.getElementById('otherId').value.trim();
            if (!otherId) {
                showStatus('대화할 상대 ID를 입력해주세요.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/chat/conversations/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        participant1_id: currentUser,
                        participant2_id: otherId
                    })
                });

                if (response.ok) {
                    const conversation = await response.json();
                    showStatus('대화방이 생성되었습니다.');
                    document.getElementById('otherId').value = '';
                    loadConversations();
                } else {
                    showStatus('대화방 생성에 실패했습니다.', 'error');
                }
            } catch (error) {
                showStatus('오류가 발생했습니다: ' + error.message, 'error');
            }
        }

        // 대화방 목록 로드
        async function loadConversations() {
            if (!currentUser) return;

            try {
                const response = await fetch(`/api/chat/users/${currentUser}/conversations/`);
                const conversations = await response.json();
                
                const listContainer = document.getElementById('conversationsList');
                
                if (conversations.length === 0) {
                    listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">대화방이 없습니다</div>';
                    return;
                }

                listContainer.innerHTML = conversations.map(conv => {
                    const otherUser = conv.participant1_id === currentUser ? conv.participant2_id : conv.participant1_id;
                    const lastMessage = conv.last_message ? conv.last_message.content.substring(0, 30) + '...' : '메시지가 없습니다';
                    
                    return `
                        <div class="conversation-item" onclick="openConversation('${conv.id}', '${otherUser}')">
                            <strong>${otherUser}</strong><br>
                            <small style="color: #666;">${lastMessage}</small>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                showStatus('대화방 목록을 불러오는데 실패했습니다.', 'error');
            }
        }

        // 대화방 열기
        async function openConversation(conversationId, otherUser) {
            // 기존 웹소켓 연결 종료
            if (ws) {
                ws.close();
            }

            currentConversation = conversationId;
            
            // 활성 대화방 표시
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 채팅 영역 표시
            document.getElementById('chatArea').style.display = 'flex';
            
            // 메시지 초기화
            messages = [];
            document.getElementById('messagesContent').innerHTML = '';
            document.getElementById('loadMoreButton').style.display = 'none';
            
            // HTTP API로 기존 메시지 로드
            await loadMessagesHttp();
            
            // 웹소켓 연결 (실패해도 HTTP로 계속 작동)
            try {
                connectWebSocket(conversationId);
            } catch (error) {
                updateConnectionStatus(false);
                showStatus('WebSocket 연결 실패. HTTP 모드로 작동합니다.', 'error');
            }
            
            // WebSocket이 안 되면 자동 새로고침 시작
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                startAutoRefresh();
                updateConnectionStatus(true); // HTTP 모드도 연결된 것으로 표시
            }
            
            showStatus(`${otherUser}와의 채팅을 시작합니다.`);
        }

        // 웹소켓 연결
        function connectWebSocket(conversationId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // WebSocket 서버는 현재 포트(8001)에서 실행
            const wsUrl = `${protocol}//${window.location.host}/ws/chat/${conversationId}/`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                updateConnectionStatus(true);
                showStatus('실시간 채팅 연결됨');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function(event) {
                updateConnectionStatus(false);
                showStatus('연결이 끊어졌습니다. 재연결을 시도합니다...', 'error');
                
                // 5초 후 재연결 시도
                setTimeout(() => {
                    if (currentConversation) {
                        connectWebSocket(currentConversation);
                    }
                }, 5000);
            };
            
            ws.onerror = function(error) {
                updateConnectionStatus(false);
                showStatus('웹소켓 연결 오류', 'error');
            };
        }

        // 웹소켓 메시지 처리
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'recent_messages':
                    // 최근 메시지들 로드
                    messages = data.messages;
                    hasMoreMessages = data.has_more;
                    renderMessages();
                    updateLoadMoreButton();
                    scrollToBottom();
                    break;
                    
                case 'chat_message':
                    // 새 메시지 추가
                    messages.push(data.message);
                    renderMessages();
                    scrollToBottom();
                    
                    // 읽음 처리 (내가 보낸 메시지가 아닌 경우)
                    if (data.message.sender_id !== currentUser) {
                        markAsRead(data.message.id);
                    }
                    break;
                    
                case 'more_messages':
                    // 이전 메시지들 추가 (맨 앞에)
                    const oldScrollHeight = document.getElementById('messagesContainer').scrollHeight;
                    messages = [...data.messages, ...messages];
                    hasMoreMessages = data.has_more;
                    renderMessages();
                    updateLoadMoreButton();
                    
                    // 스크롤 위치 유지
                    const newScrollHeight = document.getElementById('messagesContainer').scrollHeight;
                    document.getElementById('messagesContainer').scrollTop = newScrollHeight - oldScrollHeight;
                    break;
                    
                case 'typing_status':
                    // 타이핑 상태 표시
                    if (data.user_id !== currentUser) {
                        showTypingIndicator(data.is_typing);
                    }
                    break;
                    
                case 'message_read':
                    // 읽음 상태 업데이트
                    updateMessageReadStatus(data.message_id, data.user_id);
                    break;
            }
        }

        // 메시지 렌더링
        function renderMessages() {
            const messagesContent = document.getElementById('messagesContent');
            messagesContent.innerHTML = messages.map(msg => {
                const isSent = msg.sender_id === currentUser;
                return `
                    <div class="message ${isSent ? 'sent' : 'received'}" data-message-id="${msg.id}">
                        <strong>${msg.sender_id}:</strong> ${msg.content}
                        <br><small>${new Date(msg.created_at).toLocaleString()}</small>
                    </div>
                `;
            }).join('');
        }

        // 이전 메시지 더 로드
        function loadMoreMessages() {
            if (!hasMoreMessages || messages.length === 0) return;
            
            const oldestMessage = messages[0];
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'load_more_messages',
                    before_message_id: oldestMessage.id,
                    limit: 20
                }));
            }
        }

        // 더보기 버튼 업데이트
        function updateLoadMoreButton() {
            const loadMoreButton = document.getElementById('loadMoreButton');
            loadMoreButton.style.display = hasMoreMessages ? 'block' : 'none';
        }

        // 메시지 전송
        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) return;
            if (!currentConversation || !currentUser) {
                showStatus('대화방을 먼저 선택해주세요.', 'error');
                return;
            }

            // WebSocket이 연결되어 있으면 WebSocket으로 전송
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'chat_message',
                    sender_id: currentUser,
                    content: content,
                    message_type: 'text'
                }));
                messageInput.value = '';
                return;
            }

            // WebSocket이 없으면 HTTP API로 전송
            try {
                const response = await fetch(`/api/chat/conversations/${currentConversation}/messages/send/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sender_id: currentUser,
                        content: content,
                        message_type: 'text'
                    })
                });

                if (response.ok) {
                    messageInput.value = '';
                    await loadMessagesHttp(); // 메시지 새로고침
                    showStatus('메시지 전송 완료');
                } else {
                    showStatus('메시지 전송에 실패했습니다.', 'error');
                }
            } catch (error) {
                showStatus('오류가 발생했습니다: ' + error.message, 'error');
            }
        }

        // HTTP API로 메시지 로드
        async function loadMessagesHttp() {
            if (!currentConversation) return;

            try {
                const response = await fetch(`/api/chat/conversations/${currentConversation}/messages/`);
                const messagesData = await response.json();
                
                const oldMessageCount = messages.length;
                messages = messagesData;
                renderMessages();
                
                // 새 메시지가 있으면 스크롤을 아래로
                if (messagesData.length > oldMessageCount) {
                    scrollToBottom();
                }
            } catch (error) {
                showStatus('메시지를 불러오는데 실패했습니다.', 'error');
            }
        }

        // 자동 새로고침 시작 (WebSocket 대신)
        function startAutoRefresh() {
            // 기존 타이머 정리
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // 3초마다 메시지 새로고침
            autoRefreshInterval = setInterval(async () => {
                if (currentConversation) {
                    await loadMessagesHttp();
                }
            }, 3000);
            
            showStatus('실시간 채팅 연결됨 (HTTP 모드)');
        }

        // 자동 새로고침 중지
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // 키 입력 처리
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // 타이핑 처리
        function handleTyping() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            
            // 타이핑 시작
            if (!isTyping) {
                isTyping = true;
                sendTypingStatus(true);
            }
            
            // 타이핑 타이머 리셋
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                isTyping = false;
                sendTypingStatus(false);
            }, 1000);
        }

        // 타이핑 상태 전송
        function sendTypingStatus(typing) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'typing',
                    user_id: currentUser,
                    is_typing: typing
                }));
            }
        }

        // 타이핑 인디케이터 표시
        function showTypingIndicator(show) {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = show ? 'block' : 'none';
            
            if (show) {
                scrollToBottom();
            }
        }

        // 메시지 읽음 처리
        function markAsRead(messageId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'mark_as_read',
                    message_id: messageId,
                    user_id: currentUser
                }));
            }
        }

        // 연결 상태 업데이트
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = '연결됨';
                statusElement.className = 'connection-status';
            } else {
                statusElement.textContent = '연결 안됨';
                statusElement.className = 'connection-status disconnected';
            }
        }

        // 스크롤을 맨 아래로
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // 상태 메시지 표시
        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type === 'error' ? 'error' : ''}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            setUser(); // 기본 사용자 설정
        };

        // 페이지 언로드 시 웹소켓 연결 종료
        window.onbeforeunload = function() {
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>